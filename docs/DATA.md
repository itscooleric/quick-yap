# YAP Data & Metrics Guide

Complete guide to YAP's local-only metrics and usage tracking.

## Overview

YAP includes a built-in metrics system that tracks your ASR and TTS usage. All data is stored locally on your server and **never transmitted externally**.

**Key Features:**
- ‚úÖ Local-only storage (SQLite database)
- ‚úÖ No external telemetry or analytics
- ‚úÖ Privacy-focused (text storage optional and disabled by default)
- ‚úÖ Track usage patterns and productivity
- ‚úÖ Export data for your own analysis

## Accessing the Data Tab

The Data tab is always visible in the main navigation bar.

**How to Access:**
- Click "Data" in the top navigation
- Press **D** key (keyboard shortcut)
- Click "üìä Data" in the mobile toolbar (tablets/narrow viewports)

## When Metrics Are Disabled

If metrics collection is disabled, the Data tab shows:
- Clear explanation that metrics are disabled
- Information about what metrics track
- Button to open Settings with metrics configuration info
- Instructions for enabling metrics via environment variables

**To Enable Metrics:**
1. Edit `app/.env` or `app/docker-compose.yml`
2. Set `METRICS_ENABLED=true`
3. Restart the `yap-metrics` service: `docker compose restart yap-metrics`

## Metrics Dashboard

When metrics are enabled, the Data tab displays a comprehensive dashboard.

### Summary Cards

The top of the dashboard shows summary statistics for your selected time range.

**Available Metrics:**
- **Minutes Recorded** - Total audio recording time (ASR)
- **Minutes Transcribed** - Total audio processed by Whisper
- **TTS Minutes** - Total audio generated by text-to-speech
- **Total Events** - Count of all recorded events

**Time Range Selector:**
- **Today** - Statistics for current day (midnight to now)
- **7 Days** - Last week of activity
- **30 Days** - Last month of activity
- **All** - All-time statistics

### Event History

The history table shows individual events with detailed information.

**Event Columns:**
- **Time** - When the event occurred (formatted for readability)
- **Type** - Event category with color badge:
  - üî¥ **Record** - Audio recording session
  - üîµ **Transcribe** - Transcription completion
  - üü¢ **Synthesize** - TTS audio generation
- **Duration** - Length in seconds (for audio events)
- **Chars** - Character count (input or output text length)
- **Status** - Success or error indicator

**Pagination:**
- Navigate through events with Previous/Next buttons
- Shows 50 events per page by default
- Page indicator shows current position

### Actions

**Export History:**
- Click "Export JSON" to download all metrics data
- File includes metadata and complete event list
- Filename: `yap-metrics-YYYY-MM-DD.json`
- Useful for backup or external analysis

**Clear History:**
- Click "Clear History" to delete all events
- Confirmation prompt prevents accidental deletion
- Cannot be undone - use Export first if needed
- Summary statistics reset to zero

## Event Types

YAP tracks three main types of events:

### ASR Record Events

Recorded when you finish an audio recording.

**Captured Data:**
- Timestamp
- Duration (seconds of audio recorded)
- Status (success)

**Privacy Note:** Audio data is **not** stored in metrics. Only metadata (duration, timestamp) is kept.

### ASR Transcribe Events

Recorded when transcription completes.

**Captured Data:**
- Timestamp
- Duration (seconds of audio processed)
- Output character count (transcript length)
- Status (success or error)

**Privacy Note:** Transcript text is **not** stored by default. See [Text Storage](#text-storage) below.

### TTS Synthesize Events

Recorded when text-to-speech generation completes.

**Captured Data:**
- Timestamp
- Input character count (text length)
- Status (success or error)

**Privacy Note:** Input text is **not** stored by default. Audio output is not stored in metrics.

## Configuration

Metrics are configured via environment variables in the `yap-metrics` service.

### Basic Configuration

In `app/docker-compose.yml` or `app/.env`:

```bash
# Enable or disable metrics collection
METRICS_ENABLED=true

# Maximum number of events to retain
METRICS_MAX_EVENTS=5000

# Retention period in days
METRICS_RETENTION_DAYS=30
```

### Text Storage

By default, YAP metrics **do not store text content** for privacy.

**To Enable Text Storage:**

```bash
METRICS_STORE_TEXT=true
```

**‚ö†Ô∏è Privacy Warning:**
When enabled, transcript and TTS input text will be stored in the metrics database. This may include:
- Sensitive conversations
- Private notes or documents
- Confidential information

**Best Practices:**
1. Only enable if you control the server and storage
2. Regularly export and archive data
3. Clear history when switching projects or users
4. Consider disk space for text storage

### Storage Location

Metrics are stored in a SQLite database:

**Default Path:** `app/data/metrics/metrics.sqlite`

**Custom Path:**
```bash
METRICS_DB_PATH=/custom/path/metrics.sqlite
METRICS_DATA_PATH=/custom/path
```

**Docker Volume:**
The database is persisted using Docker volumes, so metrics survive container restarts.

## Automatic Cleanup

The metrics system automatically maintains your database:

### Retention Policy

Events older than `METRICS_RETENTION_DAYS` are automatically deleted when:
- A new event is recorded
- The metrics service starts up

**Default:** 30 days

### Event Limit

If event count exceeds `METRICS_MAX_EVENTS`, the oldest events are deleted.

**Default:** 5000 events

**Typical Usage:**
- Light use: ~50-100 events/day
- Medium use: ~200-500 events/day
- Heavy use: ~1000+ events/day

At default settings, 5000 events accommodates several weeks to months of heavy use.

## Data Export Format

When you export history as JSON, the file contains:

```json
{
  "exported_at": "2024-01-15T12:00:00Z",
  "total_events": 150,
  "events": [
    {
      "id": 1,
      "timestamp": "2024-01-15T10:30:00Z",
      "event_type": "asr_record",
      "duration_seconds": 45.5,
      "input_chars": 0,
      "output_chars": 0,
      "status": "success",
      "text_content": null,
      "metadata": null
    },
    {
      "id": 2,
      "timestamp": "2024-01-15T10:31:00Z",
      "event_type": "asr_transcribe",
      "duration_seconds": 45.5,
      "input_chars": 0,
      "output_chars": 234,
      "status": "success",
      "text_content": null,
      "metadata": null
    }
  ]
}
```

**Fields:**
- `id` - Unique event identifier
- `timestamp` - ISO 8601 timestamp (UTC)
- `event_type` - Type of event (asr_record, asr_transcribe, tts_synthesize)
- `duration_seconds` - Audio duration (if applicable)
- `input_chars` - Input text length (TTS)
- `output_chars` - Output text length (transcripts)
- `status` - "success" or "error"
- `text_content` - Stored text (if METRICS_STORE_TEXT=true)
- `metadata` - Additional data (reserved for future use)

## Privacy & Security

### What is NOT Stored

By default, YAP metrics do **not** include:
- ‚ùå Audio recordings
- ‚ùå Transcript text
- ‚ùå TTS input text
- ‚ùå Voice model names
- ‚ùå User identifiers
- ‚ùå IP addresses

Only metadata (timestamps, durations, character counts) is stored.

### What IS Stored

When `METRICS_STORE_TEXT=false` (default):
- ‚úÖ Event timestamps
- ‚úÖ Event types (record, transcribe, synthesize)
- ‚úÖ Durations (audio length in seconds)
- ‚úÖ Character counts (text length)
- ‚úÖ Status (success/error)

### Local-Only Storage

- All data stays on your server
- No external API calls for metrics
- No analytics sent to developers
- Database is only accessible via your YAP instance
- You control retention and deletion

### Network Isolation

The metrics service:
- Only accepts connections from other YAP services (internal Docker network)
- Is **not** exposed to external networks by default
- Requires authentication via your YAP web interface
- Cannot be accessed directly via public IP

### CORS Configuration

If you need to access metrics from external tools:

```bash
CORS_ORIGINS=https://yourdomain.com,https://analytics.yourdomain.com
```

**Security Note:** Only add trusted origins. Avoid using `*` in production.

## Use Cases

### Personal Productivity

Track your usage patterns:
- Which days/times you're most productive
- How much content you generate
- Recording vs transcription time ratios

### Project Management

Monitor project-related metrics:
- Export history at project milestones
- Compare usage across time periods
- Identify bottlenecks in workflow

### Capacity Planning

Understand your usage for infrastructure:
- Average events per day
- Peak usage times
- Storage requirements

### Research & Analysis

Export data for external analysis:
- Import JSON into spreadsheets
- Create custom visualizations
- Correlate with other productivity data

## Troubleshooting

### Data Tab Shows "Metrics Disabled"

**Problem:** Metrics service is not enabled or not running.

**Solutions:**
1. Check `METRICS_ENABLED` in docker-compose.yml (should be `true`)
2. Verify metrics service is running: `docker ps | grep yap-metrics`
3. Check service logs: `docker compose logs yap-metrics`
4. Restart service: `docker compose restart yap-metrics`

### Events Not Appearing

**Problem:** New events aren't showing in history.

**Check:**
1. Metrics enabled in configuration
2. Browser console for errors (F12 ‚Üí Console tab)
3. Network tab shows successful POST to `/api/metrics/event`
4. Metrics service logs: `docker compose logs yap-metrics`

**Common Causes:**
- Metrics service not started
- CORS configuration blocking requests
- Database file permissions

### Summary Shows Zero

**Problem:** Summary cards show 0 even with events in history.

**Check:**
1. Time range selector (try "All" to see all-time data)
2. Event timestamps are within selected range
3. Browser time zone matches server time

### Database Growing Too Large

**Problem:** Metrics database consuming significant disk space.

**Solutions:**
1. Reduce `METRICS_MAX_EVENTS` (e.g., 1000 instead of 5000)
2. Reduce `METRICS_RETENTION_DAYS` (e.g., 7 days instead of 30)
3. Disable `METRICS_STORE_TEXT` if enabled
4. Clear history and export periodically
5. Manually delete database file and restart (loses all history)

### Export Not Working

**Problem:** Export JSON button doesn't download file.

**Check:**
1. Browser allows downloads (check settings)
2. Pop-up blocker isn't preventing download
3. Check browser console for errors
4. Try different browser

## API Reference

For advanced users and integrations, metrics are accessible via REST API.

**Base URL:** `https://yourdomain/api/metrics`

**Endpoints:**
- `GET /api/metrics/config` - Get configuration
- `GET /api/metrics/summary?range=7d` - Get summary stats
- `GET /api/metrics/history?limit=50&offset=0` - Get paginated history
- `GET /api/metrics/export` - Export all data as JSON
- `POST /api/metrics/event` - Record new event (internal use)
- `DELETE /api/metrics/history` - Clear all history

**Authentication:** Same as YAP web interface (none by default, add auth via Caddy)

See `services/yap-metrics/app.py` for full API documentation.

## FAQ

**Q: Does YAP send metrics to external servers?**
A: No. All metrics are stored locally on your server and never transmitted externally.

**Q: Can I disable metrics completely?**
A: Yes. Set `METRICS_ENABLED=false` and restart the service. The Data tab will show a disabled notice.

**Q: What happens to my data if I disable metrics?**
A: Existing data is preserved. It won't be deleted, but no new events will be recorded.

**Q: Can I export metrics for use in other tools?**
A: Yes. Use the Export JSON feature to download data in a standard format that can be imported into spreadsheets, BI tools, etc.

**Q: How much disk space do metrics use?**
A: Without text storage: ~1-2 KB per event. With text storage: varies by content length. 5000 events typically use less than 10 MB.

**Q: Can multiple users share metrics?**
A: The current implementation doesn't have user separation. All events are stored in a single database. If you need per-user metrics, run separate YAP instances.

**Q: Does clearing history affect my ASR/TTS functionality?**
A: No. Clearing metrics history only removes tracking data. Your recordings, transcripts, and TTS functionality are unaffected.

## Next Steps

- **Usage Tracking**: Start using YAP to see metrics populate
- **Export Data**: Try exporting to see the JSON format
- **Configuration**: Adjust retention settings for your needs
- **User Guide**: See the [User Guide](USER_GUIDE.md) for complete UI documentation
